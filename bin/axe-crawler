#!/usr/bin/env node
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("validator"),require("axios"),require("cheerio"),require("fs"),require("minimist"),require("knex"),require("objection"),require("selenium-webdriver"),require("selenium-webdriver/chrome"),require("axe-webdriverjs"),require("marked"),require("escape-html")):"function"==typeof define&&define.amd?define(["validator","axios","cheerio","fs","minimist","knex","objection","selenium-webdriver","selenium-webdriver/chrome","axe-webdriverjs","marked","escape-html"],t):t(e.validator,e.axios,e.cheerio,e.fs,e.minimist,e.Knex,e.objection,e.webDriver,e.chromeDriver,e.axeBuilder,e.marked,e.escape)}(this,function(e,t,r,n,i,o,s,a,l,u,c,d){"use strict";function h(e){return(t,r)=>e.random?Math.random()<e.random?(t.push(r),t):t:(t.push(r),t)}function f(e){return!/(uploads\/\d{4}\/\d{2}\/)/.test(e)&&!/attachment_id/.test(e)&&!/\.(exe|wmv|avi|flv|mov|mkv|mp..?|swf|ra.?|rm|as.|m4[av]|smi.?|doc|docx|ppt|pptx|pps|ppsx|jpg|png|gif|pdf)$/.test(e)}function p(e){return t=>new RegExp(`^https?://([\\w&&[^\\?=\\&\\.]]*\\.?)*?${e}/?.*$`).test(t)||/^\/\w+/.test(t)}function m(e){return!new RegExp("mailto:\\w+").test(e)}function y(t){const{domain:r,ignore:n,whitelist:i}=t,o=new RegExp(n||"^$"),s=new RegExp(i||".*");return t=>e.isURL(t)&&f(t)&&m(t)&&p(r)(t)&&s.test(t)&&(!!i||!o.test(t))}function b(e){return!(e<0)&&Number.isInteger(e)}function g(e){return(t,r)=>(e.viewPorts.forEach(e=>{t.push({url:r,viewPort:e})}),t)}function v(e){const{domain:t}=this[A];return e.filter(e=>!(e instanceof Error)).map(e=>this[J](t,e)).reduce(x,new Set).difference(this[C])}function w(e,t){const r=e.replace(new RegExp("^(https?://(\\w+\\.?)+)/(.*)$"),"$1");return n=>{if(t[n].attribs){const i=t[n].attribs.href;if(i)return i.replace(new RegExp(`^(?!https?://)(?!${e}/)(/?)(.*)`),`${r}/$2`).replace(new RegExp(`^${r}//`),"http://")}return null}}function S(e,t){if(void 0===t)return new Set;if(200===t.status){const e=r.load(t.data)("a"),n=t.config.url;return new Set(Object.keys(e).map(w(n,e)).filter(e=>"string"==typeof e).filter(this[M]).map(e=>e.replace(/^https:\/\//,"http://")))}return new Set}function x(e,t){if(e instanceof Set){for(const r of e)t.add(r);return t}return t}function $(){const{logger:e,random:t}=this;t>0&&t<=1||(e.error(`Invalid random sampling rate specified: ${t}.  Defaulting to 100%`),this.random=1)}function P(){const e=i(process.argv.slice(2));e.domain=e._.last(),delete e._,e.viewPorts&&(e.viewPorts=E(e.viewPorts),0===e.viewPorts.length&&delete e.viewPorts);let{verbose:t}=e;e.dryRun&&(t=e.verbose||"debug",e.check=0),e.quiet&&(t="quiet");const r=new K(t);return e.dryRun&&r.force(`Performing dry run with ${e.verbose} level logging`),Object.assign(e,{logger:r,verbose:t})}function k(){const{logger:e,configFile:t}=this[ne],r=t||te;let i={};try{i=JSON.parse(n.readFileSync(r))}catch(t){"ENOENT"===t.code&&t.path===r?e.error("No config file found"):t instanceof SyntaxError&&e.error(`Invalid JSON config file ${r}\n\nIgnoring JSON config file...`)}return i}function E(e){return e.split(",").map(t=>{const r=/(\w+):(\d+)x(\d+)/;try{const[,n,i,o]=r.exec(t);return{name:n,width:i,height:o}}catch(t){throw new Error("Invalid viewports: ",e)}}).filter(e=>e)}function O(){const e=this[me],t=`aXe Accessibility Engine Report for ${this[ue].domain}  \n${(new Date).toString()}`;e(`<!doctype html> <html lang="en"><head><title>${t}</title><meta name="viewport" content="width=device-width, initial-scale=1">${he}${fe}</head><body><div class="container"><div class="row"><div class="col-xs-12">${c(`# ${t}`)}`),e(c("This report is not a complete accessibility audit.  This report only documents those accessibility features tested by the axe-core library, and should not be considered exhaustive of the possible accessibility issues a website may have.  Use this report as a tool in a complete and comprehensive process of reviewing this site for accessibility issues.  More information regarding the features tested by the axe-core library may be found at [axe-core.org](https://axe-core.org/)")),1!==this[ue].random&&e(c(`This report represents only a random sample of ${Math.round(100*this[ue].random)}% of all webpages on this domain.`))}function T(e,t){const r=new Set;return e[t].forEach(({viewPort:e,report:n})=>{JSON.parse(n).forEach(({description:e})=>{this[de][t]+=1,r.add(`* ${d(e)}\n`)})}),r.size>0?c([...r].reduce((e,t)=>e+t,"")):`No ${t} detected by axe-core`}function N(){(0,this[me])("</body><script><\/script></html>"),n.closeSync(this[ce])}function q(e){return e.reduce((e,{viewPort:t,url:r,report:n})=>e+JSON.parse(n).length,0)}function _(e,{html:t,any:r,all:n,none:i}){return e+=`<li>${d(t)}`,r.forEach(({message:t})=>{e+=`<br />${d(t)}`}),n.forEach(({message:t})=>{e+=`<br />${d(t)}`}),i.forEach(({message:t})=>{e+=`<br />${d(t)}`}),e+="</li>"}function R(e,t){let r="<ul>";return e.forEach(({viewPort:e,report:n})=>{const i=JSON.parse(n);r+=`<li style="list-style: none; height: 15px;"><div class="col-xs-2">${e}:</div><div class="col-xs-10"> ${i.length} ${t}</div></li>`}),r+="</ul>"}function D(e){const{viewPort:t,url:r,report:n}=e,i=JSON.parse(n);let o=`<h4>${t.toUpperCase()}</h4><br/><ol>`;return i.length>0?o+=`${i.reduce((e,{description:t,nodes:r,impact:n})=>(e+=`<li>${n?`${n.toUpperCase()}: `:""}${d(t)}<br />`,e+="<span>Affected Nodes: </span><ul>",e+=r.reduce(_,""),e+="</ul></li>"),"")}</ol>`:""}function j(e,t){return e[t.viewPort]=JSON.parse(t.report),e}t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n,i=i&&i.hasOwnProperty("default")?i.default:i,o=o&&o.hasOwnProperty("default")?o.default:o,a=a&&a.hasOwnProperty("default")?a.default:a,l=l&&l.hasOwnProperty("default")?l.default:l,u=u&&u.hasOwnProperty("default")?u.default:u,c=c&&c.hasOwnProperty("default")?c.default:c,d=d&&d.hasOwnProperty("default")?d.default:d;!function(){function e(e){this.value=e}function t(t){function r(i,o){try{var s=t[i](o),a=s.value;a instanceof e?Promise.resolve(a.value).then(function(e){r("next",e)},function(e){r("throw",e)}):n(s.done?"return":"normal",s.value)}catch(e){n("throw",e)}}function n(e,t){switch(e){case"return":i.resolve({value:t,done:!0});break;case"throw":i.reject(t);break;default:i.resolve({value:t,done:!1})}(i=i.next)?r(i.key,i.arg):o=null}var i,o;this._invoke=function(e,t){return new Promise(function(n,s){var a={key:e,arg:t,resolve:n,reject:s,next:null};o?o=o.next=a:(i=o=a,r(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}();var F=function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(i,o){try{var s=t[i](o),a=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(a).then(function(e){n("next",e)},function(e){n("throw",e)});e(a)}return n("next")})}};let I=(()=>{var e=F(function*(e){const{logger:r}=this[A],n=[];return yield[...e].reduce(function(e,i,o){return e.then(function(){return r.debug(`Fetching #${o+1}: ${i}`),t.get(i).catch(function(e){return e}).then(function(e){return n.push(e)})})},Promise.resolve([])),n});return function(t){return e.apply(this,arguments)}})();const A=Symbol("Options"),C=Symbol("Set of unique links to be tested"),J=Symbol("Add all links on a page to UNIQUE_LINKS"),M=Symbol("Filter out broken, invalid, media, etc. links"),z=Symbol("Perform axios.get on each url in an array and return array of completed responses"),L=Symbol("Build a set of links scraped from an array of axios reponses");class U{constructor(e){this[A]=e,this[C]=new Set,this[J]=S.bind(this),this[M]=y(e),this[z]=I.bind(this),this[L]=v.bind(this)}crawl(){var t=this;return F(function*(){const{domain:r,depth:n=5,logger:i}=t[A],o=`http://${r}`;if(!e.isURL(o))throw new Error(`Invalid url: ${o}`);if(t[C].add(o),0===n)return t[C];try{i.debug(`Crawling ${o}`);let e=t[C];for(let r=0;r<n;r+=1){i.debug(`Crawling for links at DEPTH ${r+1}`);const n=yield t[z](e);if(0===(e=t[L](n)).size)break;i.debug(`${e.size} links found`);for(const r of e)t[C].add(r)}return t[C]}catch(e){return i.error("Error crawling for links: ",e),process.exit(1)}})()}}class B extends s.Model{static createTable(e){return F(function*(){return yield e.schema.dropTableIfExists("violations"),e.schema.createTableIfNotExists("violations",function(e){e.increments("id").primary(),e.string("url"),e.string("viewPort"),e.string("report")})})()}static get tableName(){return"violations"}}class Q extends s.Model{static createTable(e){return F(function*(){return yield e.schema.dropTableIfExists("passes"),e.schema.createTableIfNotExists("passes",function(e){e.increments("id").primary(),e.string("url"),e.string("viewPort"),e.string("report")})})()}static get tableName(){return"passes"}}class H extends s.Model{static createTable(e){return F(function*(){return yield e.schema.dropTableIfExists("axe_results"),e.schema.createTableIfNotExists("axe_results",function(e){e.increments("id").primary(),e.string("url").unique()})})()}static get tableName(){return"axe_results"}static get relationMappings(){return{violations:{relation:s.Model.HasManyRelation,modelClass:B,join:{from:"violations.url",to:"axe_results.url"}},passes:{relation:s.Model.HasManyRelation,modelClass:Q,join:{from:"passes.url",to:"axe_results.url"}}}}}class K{constructor(e){switch(e){case"info":this.verbose="info";break;case"debug":this.verbose="debug";break;case"quiet":this.quiet=!0;break;default:this.verbose="error"}}debug(...e){"debug"!==this.verbose||this.quiet||console.log("DEBUG:",...e)}info(...e){this.quiet||"info"!==this.verbose&&"debug"!==this.verbose||console.log("INFO:",...e)}error(...e){void 0===this.verbose||this.quiet||console.error("ERROR:",...e)}force(...e){console.log(...e)}}var W=(()=>{var e=F(function*(e){const t=new K("debug");return H.knex(e),B.knex(e),Q.knex(e),yield H.createTable(e),yield B.createTable(e),yield Q.createTable(e),{create:{axe_result:(()=>{var e=F(function*({url:e,viewPort:r,violations:n,passes:i}){return Promise.all([H.query().insert({url:e}).catch(function(e){if(!e.message.match("SQLITE_CONSTRAINT: UNIQUE"))throw e}),B.query().insert({url:e,viewPort:r,report:n}),Q.query().insert({url:e,viewPort:r,report:i})]).catch(function(e){t.error(e)})});return function(t){return e.apply(this,arguments)}})()},read:{axe_result:function({url:e,viewPort:r}){H.query().then(function(e){return t.debug(`Result received: ${JSON.stringify(e)}`)}).catch(function(e){return t.error(`Error reading from DB: ${e}`)}),B.query().then(function(e){return t.debug(`Result received: ${JSON.stringify(e)}`)}).catch(function(e){return t.error(`Error reading from DB: ${e}`)})},tested_pages:function(){return H.query()},violations_summary:function({url:e}){return B.query().where("url",e)},passes_summary:function({url:e}){return Q.query().where("url",e)},summary:(()=>{var e=F(function*({url:e}){return{violations:yield B.query().where("url",e),passes:yield Q.query().where("url",e)}});return function(t){return e.apply(this,arguments)}})()},update:{},delete:{}}});return function(t){return e.apply(this,arguments)}})();const G=Symbol("Database type"),X=Symbol("Database CREATE"),V=Symbol("Database READs"),Y=Symbol("Database UPDATE"),Z=Symbol("Database DELETE");class ee{constructor({type:e="memory"}){this[G]=e}initialize(){var e=this;return F(function*(){switch(e[G]){case"memory":e._db=o({client:"sqlite3",connection:{filename:":memory:"},useNullAsDefault:!0});break;case"file":e._db=o({client:"sqlite3",connection:{filename:"axe-crawler.db"},useNullAsDefault:!0});break;default:throw new TypeError("Invalid SQLite database type")}const t=yield W(e._db);e[X]=t.create,e[V]=t.read,e[Y]=t.update,e[Z]=t.delete})()}close(){this._db.close()}create(e,t){return this[X][e](t)}read(e,t){return this[V][e](t)}update(e,t){return this[Y][e](t)}delete(e,t){return this[Z][e](t)}}const te="./.axe-crawler.json",re={depth:5,check:void 0,output:"reports",ignore:"^$",whitelist:".*",random:1,viewPorts:[{name:"mobile",width:360,height:640},{name:"tablet_vertical",width:768,height:1024},{name:"tablet_horizontal",width:1024,height:768},{name:"desktop",width:1440,height:900}],verbose:"error",useFileOver:50},ne=Symbol("Command line arguments"),ie=Symbol("JSON specified configuration"),oe=Symbol("Default configuration");class se{constructor(e={}){this[oe]=re,this[ne]=P.call(this),this[ie]=k.call(this),Object.assign(this,this[oe],this[ie],this[ne],e),$.call(this),this.logger.debug("Crawling with options: \n",this)}setNumberToCheck(e){const{check:t}=this;this.numToCheck=Math.min(b(t)?t:1/0,e.size)}configureDB(){var e=this;return F(function*(){const{random:t,viewPorts:r,numToCheck:n,useFileOver:i,logger:o}=e;t*n*r.length>i?(o.info(`Over ${i} page views to test, switching to SQLite file mode to store results`),e.db=new ee({type:"file"})):(o.debug(`Fewer than ${i} page views, using in-memory SQLite to store results`),e.db=new ee({type:"memory"})),yield e.db.initialize()})()}}let ae=(()=>{var e=F(function*(e){var t=this;const r=this[me];r(c("## Summary of Overall Test Results")),r('<table class="summary-table"><thead><tr><th scope="col">URL</th><th scope="col">Failing Tests</th><th scope="col">Passing Tests</th></tr></thead><tbody>'),yield Promise.all(e.map((()=>{var e=F(function*({url:e}){const n=yield t[ue].db.read("summary",{url:e});yield r(`<tr><th scope="row">${e}</th>`),yield r(`<td>${T.call(t,n,"violations")}</td>`),yield r(`<td>${T.call(t,n,"passes")}</td></tr>`)});return function(t){return e.apply(this,arguments)}})())),r("</tbody></table>")});return function(t){return e.apply(this,arguments)}})(),le=(()=>{var e=F(function*(e){var t=this;const r=this[me];r(c(`## Detailed List of Failing Tests: ${this[de].violations} failing tests`)),yield Promise.all(e.map((()=>{var e=F(function*({url:e}){const n=yield t[ue].db.read("violations_summary",{url:e}),i=q(n);r(c(`### ${d(e)} ${i} violations`)),r("<br/>"),r(R(n,"failed tests")),yield Promise.all(n.map(function(e){return r(D(e))}))});return function(t){return e.apply(this,arguments)}})())),r(c(`## Detailed List of Passing Tests: ${this[de].passes} passing tests`)),yield Promise.all(e.map((()=>{var e=F(function*({url:e}){const n=yield t[ue].db.read("passes_summary",{url:e}),i=q(n);r(c(`### ${d(e)} ${i} passing tests`)),r("<br/>"),r(R(n,"passing tests")),yield Promise.all(n.map(function(e){return r(D(e))}))});return function(t){return e.apply(this,arguments)}})()))});return function(t){return e.apply(this,arguments)}})();const ue=Symbol("Options"),ce=Symbol("Filename"),de=Symbol("Total count of passing and failing tests"),he='<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.8.0/github-markdown.css"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">',fe="<style> h1 { text-align: center; } ol > li { padding-bottom: 15px; font-weight: 500 } ul > li { font-weight: 400; font-size: 12px; } ol > li > span { font-weight: 400; } thead th { text-align: center; } tr { border: 1px solid lightsalmon; } tbody th, tbody td { padding: 5px; text-align: left; vertical-align: text-top; font-weight: normal; } table.summary-table { width: 100%; }</style>",pe=Symbol("Prepare HTML File"),me=Symbol("Append an html string to the report file"),ye=Symbol("Write html summary table"),be=Symbol("Write complete test results to html"),ge=Symbol("Append closing tags and close html file");class ve{constructor(e){this[ue]=e,this[de]={passes:0,violations:0},this[pe]=O.bind(this),this[ye]=ae.bind(this),this[be]=le.bind(this),this[ge]=N.bind(this)}open(e="report.html"){var t=this;return F(function*(){n.writeFileSync(e,""),t[ce]=n.openSync(e,"w"),t[me]=function(e){return n.writeSync(t[ce],e)}})()}write(e){var t=this;return F(function*(){yield t[pe](),yield t[ye](e),yield t[be](e)})()}close(){var e=this;return F(function*(){e[ge]()})()}}let we=(()=>{var e=F(function*(e){var t=this;const r=this[$e],{logger:n}=this[Se];yield r(`{"date": "${(new Date).toString()}","title":"aXe Accessibility Engine Report for ${this[Se].domain}","reports": {`),yield Promise.all(e.map((()=>{var e=F(function*({url:e},n,i){const o=yield t[Se].db.read("violations_summary",{url:e}),s=yield t[Se].db.read("passes_summary",{url:e}),a={violations:o.reduce(j,{}),passes:s.reduce(j,{})};r(`"${e}": ${JSON.stringify(a)}`),n!==i.length-1&&r(",")});return function(t,r,n){return e.apply(this,arguments)}})())),n.debug("Ending JSON output"),r("}}")});return function(t){return e.apply(this,arguments)}})();const Se=Symbol("Options"),xe=Symbol("Filename"),$e=Symbol("Append an html string to the report file"),Pe=Symbol("Process data and write to JSON output");class ke{constructor(e){this[Se]=e,this[Pe]=we.bind(this)}open(e="report.json"){n.writeFileSync(e,""),this[xe]=n.openSync(e,"w"),this[$e]=(e=>n.writeSync(this[xe],e))}write(e){var t=this;return F(function*(){yield t[Pe](e)})()}close(){n.closeSync(this[xe])}}let Ee=(()=>{var e=F(function*(e){const{logger:t,db:r}=this[Oe];try{const{url:n,viewPort:{name:i,width:o,height:s}}=e,c=new l.Options;c.addArguments("headless","disable-gpu",`--window-size=${o},${s}`);const d=(new a.Builder).forBrowser("chrome").setChromeOptions(c).build(),h=yield new Promise(function(r,o){d.get(n).then(function(){t.debug("Test case: ",e),t.info(`Got ${n}`),t.info(`Testing ${n} ${i}`),u(d).analyze(function(e,s){s&&o(s),t.debug(`Results for ${n} ${i} received`),r(e),d.close()})})});yield r.create("axe_result",{url:n,violations:JSON.stringify(h.violations),passes:JSON.stringify(h.passes),viewPort:`${i}:${o}x${s}`})}catch(e){t.error("Error encountered in using Selenium Webdriver: "),t.error(e),process.exit(1)}});return function(t){return e.apply(this,arguments)}})();const Oe=Symbol("Options"),Te=Symbol("Queue"),Ne=Symbol("Take a random sample"),qe=Symbol("Run axe-core tests on a page"),_e=Symbol("Create a list of views to test");class Re{constructor(e){this[Oe]=e,this[qe]=Ee.bind(this),this[Ne]=h(this[Oe]),this[_e]=g(this[Oe])}queue(e){const{check:t}=this[Oe],r=Math.min(b(t)?t:1/0,e.size);this[Te]=[...e].reduce(this[Ne],[]).slice(0,r).reduce(this[_e],[])}run(){var e=this;return F(function*(){yield Promise.all(e[Te].map(e[qe]))})()}report(){var e=this;return F(function*(){const{logger:t,db:r}=e[Oe],n=yield r.read("tested_pages");t.info("Saving JSON report");const i=new ke(e[Oe]);yield i.open(),yield i.write(n),yield i.close(),t.info("Saving HTML Report");const o=new ve(e[Oe]);yield o.open(),yield o.write(n),yield o.close()})()}}let De=(()=>{var e=F(function*(){const e=new se,t=new U(e),{logger:r,viewPorts:n,random:i,domain:o}=e,s=yield t.crawl();e.setNumberToCheck(s),r.info(`Found ${s.size} links within ${o}`),r.debug("Queue to be tested: ",s),r.info(`Based on options, testing ${e.numToCheck} urls`),i>0&&i<1&&r.info(`Selecting random sample: ${i} of ${e.numToCheck} urls`),yield e.configureDB(),r.debug(`Testing ${n.length} viewPorts: `),n.forEach(function({name:e,width:t,height:n}){r.debug(`\t${e}: ${t}x${n}`)});try{Object.freeze(e);const t=new Re(e);yield t.queue(s),yield t.run(),yield t.report()}catch(e){r.error(e),process.exit(1)}process.exit(0)});return function(){return e.apply(this,arguments)}})();!function(){const e=Function.bind.call(Function.call,Array.prototype.reduce),t=Function.bind.call(Function.call,Object.prototype.propertyIsEnumerable),r=Function.bind.call(Function.call,Array.prototype.concat),n=Reflect.ownKeys;Set.prototype.difference=function(e){const t=new Set(this);for(const r of e)t.delete(r);return t},Object.entries||(Object.entries=function(i){return e(n(i),(e,n)=>r(e,"string"==typeof n&&t(i,n)?[[n,i[n]]]:[]),[])}),Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]})}(),De()});
