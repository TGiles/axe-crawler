#!/usr/bin/env node
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("selenium-webdriver"),require("selenium-webdriver/chrome"),require("axe-webdriverjs"),require("validator"),require("fs"),require("marked"),require("escape-html"),require("axios"),require("cheerio")):"function"==typeof define&&define.amd?define(["selenium-webdriver","selenium-webdriver/chrome","axe-webdriverjs","validator","fs","marked","escape-html","axios","cheerio"],t):t(e.webDriver,e.chromeDriver,e.axeBuilder,e.validator,e.fs,e.marked,e.escape,e.axios,e.cheerio)}(this,function(e,t,r,n,o,i,s,a,c){"use strict";function l(e){return(t,r)=>e.random?Math.random()<e.random?(t.push(r),t):t:(t.push(r),t)}function u(e){return!/(uploads\/\d{4}\/\d{2}\/)/.test(e)&&!/attachment_id/.test(e)&&!/\.(exe|wmv|avi|flv|mov|mkv|mp..?|swf|ra.?|rm|as.|m4[av]|smi.?|doc|docx|ppt|pptx|pps|ppsx|jpg|png|gif|pdf)$/.test(e)}function d(e){return t=>new RegExp(`^https?://([\\w&&[^\\?=\\&\\.]]*\\.?)*?${e}/?.*$`).test(t)||/^\/\w+/.test(t)}function f(e){const t=new RegExp(e.ignore||"^$"),r=new RegExp(e.whitelist||".*");return o=>n.isURL(o)&&u(o)&&d(e.domains.last())(o)&&r.test(o)&&(!!e.whitelist||!t.test(o))}function h(e){return!(e<0)&&Number.isInteger(e)}function p(e,t,r){const n={date:(new Date).toString(),title:`aXe Accessibility Engine Results for ${r.domains.last()}`,reports:t},i=JSON.stringify(n,null,2);o.writeFile(e,i)}function g(e,t){return Object.entries(e[t]).reduce((e,[t,r])=>e+r.length,0)}function m(e,t,r){return e+="<ul>",Object.entries(t[r]).forEach(([t,n])=>{e+=`<li style="list-style: none; height: 15px;"><div class="col-xs-2">${t}:</div><div class="col-xs-10"> ${n.length} ${r}</div></li>`}),e+="</ul>"}function v(e,t){const r=new Set;return Object.entries(e[t]).forEach(([e,t])=>{t.forEach(({description:e})=>{r.add(`* ${s(e)}\n`)})}),r.size>0?i([...r].reduce((e,t)=>e+t,"")):`No ${t} detected by axe-core`}function b(e,t){let r=i("## Summary of Overall Test Results");return r+='<table class="summary-table"><thead><tr><th scope="col">URL</th><th scope="col">Failing Tests</th><th scope="col">Passing Tests</th></thead><tbody>',Object.entries(e).forEach(([e,t])=>{r+=`<tr><th scope="row">${e}</th>`,r+=`<td>${v(t,"violations")}</td>`,r+=`<td>${v(t,"passes")}</td></tr>`}),r+="</tbody></table>"}function w(e,t,r){function n(e,{html:t,any:r,all:n,none:o}){return e+=`<li>${s(t)}`,r.forEach(({message:t})=>{e+=`<br />${s(t)}`}),n.forEach(({message:t})=>{e+=`<br />${s(t)}`}),o.forEach(({message:t})=>{e+=`<br />${s(t)}`}),e+="</li>"}function a([e,t]){if(t.length>0){const r=`<h4>${e.toUpperCase()}</h4><br/><ol>${t.reduce((e,{description:t,nodes:r,impact:o})=>(e+=`<li>${o?`${o.toUpperCase()}: `:""}${s(t)}<br />`,e+="<span>Affected Nodes: </span><ul>",e+=r.reduce(n,""),e+="</ul></li>"),"")}`;u+=`${r}</ol>`}}const c=`aXe Accessibility Engine Report for ${r.domains.last()}  \n${(new Date).toString()}`;let l='<!doctype html> <html lang="en"><head>';l+=`<title>${c}</title>`,l+='<meta name="viewport" content="width=device-width, initial-scale=1">',l+='<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.8.0/github-markdown.css">',l+='<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">',l+=q;let u='</head><body><div class="container"><div class="row"><div class="col-xs-12">';u+=i(`# ${c}`),u+=i("This report is not a complete accessibility audit.  This report only documents those accessibility features tested by the axe-core library, and should not be considered exhaustive of the possible accessibility issues a website may have.  Use this report as a tool in a complete and comprehensive process of reviewing this site for accessibility issues.  More information regarding the features tested by the axe-core library may be found at [axe-core.org](https://axe-core.org/)"),1!==r.random&&(u+=i(`This report represents only a random sample of ${Math.round(100*r.random)}% of all webpages on this domain.`)),u+=b(t,r),u+='<div class="row"><div class="col-xs-12">';try{u+=`${i(`## Detailed List of Failing Tests: ${Object.entries(t).reduce((e,[t,r])=>e+g(r,"violations"),0)} total failing tests`)}</div></div>`}catch(e){S.error("Error counting failed tests: ",e),u+=i("## Detailed List of Failing Tests")}u+='<div class="row"><div class="col-xs-12">',Object.entries(t).forEach(([e,t])=>{const r=g(t,"violations");u+=i(`### ${s(e)} ${r} violations`),u=m(u,t,"violations"),u+="<br/>",Object.entries(t.violations).forEach(a,"")});try{u+=`${i(`## Summary of Passing Tests: ${Object.entries(t).reduce((e,[t,r])=>e+g(r,"passes"),0)} total passing tests`)}</div></div>`}catch(e){S.error("Error counting passed tests: ",e),u+=i("## Summary of Passing Tests")}Object.entries(t).forEach(([e,t])=>{const r=g(t,"passes");u+=i(`### ${s(e)} ${r} passes`),u=m(u,t,"passes"),u+="<br />",Object.entries(t.passes).forEach(a,"")}),u+="</div></div>";o.writeFile(e,l+u+"</body><script><\/script></html>")}function y(e,t){const r=e.replace(new RegExp("^(https?://(\\w+\\.?)+)/(.*)$"),"$1");return n=>{if(t[n].attribs){const o=t[n].attribs.href;if(o)return o.replace(new RegExp(`^(?!https?://)(?!${e}/)(/?)(.*)`),`${r}/$2`).replace(new RegExp(`^${r}//`),"http://")}return null}}function $(e,t,r=(e=>!0)){if(void 0===t)return new Set;if(200===t.status){const e=c.load(t.data)("a"),n=t.config.url;return new Set(Object.keys(e).map(y(n,e)).filter(e=>"string"==typeof e).filter(r).map(e=>e.replace(/^https:\/\//,"http://")))}return new Set}function x(e,t){if(e instanceof Set){for(const r of e)t.add(r);return t}return t}function P(e){return e.split(",").map(t=>{const r=/(\w+):(\d+)x(\d+)/;try{const[,n,o,i]=r.exec(t);return{name:n,width:o,height:i}}catch(t){throw new Error("Invalid viewports: ",e)}}).filter(e=>e)}function O(){const e=N(process.argv.slice(2));e.domains=e._,delete e._,e.viewPorts&&(e.viewPorts=P(e.viewPorts),0===e.viewPorts.length&&delete e.viewPorts),e.dryRun&&(e.verbose=e.verbose||"debug",S.force(`Performing dry run with ${e.verbose} level logging`),e.check=0),S.configure(e.verbose),e.hasOwnProperty("quiet")&&S.configure("quiet");const t=e.configFile||D;let r={};try{r=JSON.parse(F.readFileSync(t))}catch(e){"ENOENT"===e.code&&e.path===t?S.error("No config file found"):e instanceof SyntaxError&&(S.error(`Invalid JSON config file ${t}`),S.error("Ignoring JSON config file..."))}return Object.assign(I,r,e)}function E(e,{result:t,viewPort:r}){try{e[t.url]=Object.assign({violations:{},passes:{}},e[t.url]),e[t.url].violations[r.name]=t.violations,e[t.url].passes[r.name]=t.passes}catch(e){S.error(e)}return e}function k(e){const{output:t}=e;return r=>{S.debug("Creating reports: ",`${t}.json`,`${t}.html`);const n=r.reduce(E,{});p(`${t}.json`,n,e),w(`${t}.html`,n,e)}}function j(e){return(t,r)=>(e.viewPorts.forEach(e=>{t.push({url:r,viewPort:e})}),t)}e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,o=o&&o.hasOwnProperty("default")?o.default:o,i=i&&i.hasOwnProperty("default")?i.default:i,s=s&&s.hasOwnProperty("default")?s.default:s,a=a&&a.hasOwnProperty("default")?a.default:a,c=c&&c.hasOwnProperty("default")?c.default:c;var S={info:function(...e){process.quiet||"info"!==process.verbose&&"debug"!==process.verbose||console.log("INFO:",...e)},error:function(...e){void 0===process.verbose||process.quiet||console.error("ERROR:",...e)},debug:function(...e){"debug"!==process.verbose||process.quiet||console.log("DEBUG:",...e)},force:function(...e){console.log(...e)},configure:function(e){switch(e){case"info":process.verbose="info";break;case"debug":process.verbose="debug";break;case"quiet":process.quiet=!0;break;default:process.verbose="error"}}};const q="<style> h1 { text-align: center; } ol > li { padding-bottom: 15px; font-weight: 500 } ul > li { font-weight: 400; font-size: 12px; } ol > li > span { font-weight: 400; } thead th { text-align: center; } tr { border: 1px solid lightsalmon; } tbody th, tbody td { padding: 5px; text-align: left;    vertical-align: text-top; font-weight: normal; } table.summary-table { width: 100%; }</style>";!function(){function e(e){this.value=e}function t(t){function r(o,i){try{var s=t[o](i),a=s.value;a instanceof e?Promise.resolve(a.value).then(function(e){r("next",e)},function(e){r("throw",e)}):n(s.done?"return":"normal",s.value)}catch(e){n("throw",e)}}function n(e,t){switch(e){case"return":o.resolve({value:t,done:!0});break;case"throw":o.reject(t);break;default:o.resolve({value:t,done:!1})}(o=o.next)?r(o.key,o.arg):i=null}var o,i;this._invoke=function(e,t){return new Promise(function(n,s){var a={key:e,arg:t,resolve:n,reject:s,next:null};i?i=i.next=a:(o=i=a,r(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}();var R=function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(o,i){try{var s=t[o](i),a=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(a).then(function(e){n("next",e)},function(e){n("throw",e)});e(a)}return n("next")})}},T=(()=>{var e=R(function*(e,t=5,r){const o=`http://${e}`;if(!n.isURL(o))throw new Error(`Invalid url: ${o}`);if(0===t)return new Set([o]);const i=yield a.get(o).catch(S.error);S.debug("Crawling for links at DEPTH 0");const s=yield $(0,i,r);let c=new Set([...s]);for(let e=1;e<t;e+=1){S.debug(`Crawling for links at DEPTH ${e}`);const n=[...c].map(a.get).map(function(e){return e.catch(function(e){return e})});0===(c=(yield Promise.all(n)).filter(function(e){return!(e instanceof Error)}).map(function(e){return $(0,e,r)}).reduce(x,new Set).difference(s)).size&&(e=t);for(const e of c)s.add(e)}return s});return function(t){return e.apply(this,arguments)}})();const F=require("fs"),N=require("minimist"),D="./.axe-crawler.json",I={depth:5,check:void 0,output:"reports",ignore:".*",whitelist:".*",random:!1,viewPorts:[{name:"mobile",width:360,height:640},{name:"tablet_vertical",width:768,height:1024},{name:"tablet_horizontal",width:1024,height:768},{name:"desktop",width:1440,height:900}],verbose:"error"};let _=(()=>{var n=R(function*(n){S.debug("Test case: ",n);const{url:o,viewPort:{name:i,width:s,height:a},viewPort:c}=n,l=new t.Options;l.addArguments("headless","disable-gpu",`--window-size=${s},${a}`);const u=(new e.Builder).forBrowser("chrome").setChromeOptions(l).build();return yield new Promise(function(e,t){S.info(`Getting ${o}`),u.get(o).then(function(){S.info(`Testing ${o} ${i}`),r(u).analyze(function(r,n){n&&t(n),S.debug(`Results for ${o} ${i} received`),e({result:r,viewPort:c}),u.close()})})})});return function(e){return n.apply(this,arguments)}})(),z=(()=>{var e=R(function*(){const e=O(),t=e.domains.last();S.debug("Crawling with options: \n",e);const r=yield T(t,e.depth,f(e));S.info(`Found ${r.size} links within ${t}`),S.debug("Queue to be tested: ",r);const n=Math.min(h(e.check)?e.check:1/0,r.size);S.info(`Based on options, testing ${n} urls`),e.random>0&&e.random<1?S.info(`Selecting random sample ${e.random} of total`):e.random=1,S.debug(`Testing ${e.viewPorts.length} views: `),e.viewPorts.forEach(function(e){S.debug(`\t${e.name}: ${e.width}x${e.height}`)}),Promise.all([...r].reduce(l(e),[]).slice(0,n).reduce(j(e),[]).map(_)).then(k(e)).catch(S.error)});return function(){return e.apply(this,arguments)}})();!function(){const e=Function.bind.call(Function.call,Array.prototype.reduce),t=Function.bind.call(Function.call,Object.prototype.propertyIsEnumerable),r=Function.bind.call(Function.call,Array.prototype.concat),n=Reflect.ownKeys;Set.prototype.difference=function(e){const t=new Set(this);for(const r of e)t.delete(r);return t},Object.entries||(Object.entries=function(o){return e(n(o),(e,n)=>r(e,"string"==typeof n&&t(o,n)?[[n,o[n]]]:[]),[])}),Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]})}(),z()});
