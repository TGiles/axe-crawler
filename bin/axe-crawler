#!/usr/bin/env node
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("selenium-webdriver"),require("selenium-webdriver/chrome"),require("axe-webdriverjs"),require("validator"),require("fs"),require("marked"),require("escape-html"),require("axios"),require("cheerio")):"function"==typeof define&&define.amd?define(["selenium-webdriver","selenium-webdriver/chrome","axe-webdriverjs","validator","fs","marked","escape-html","axios","cheerio"],t):t(e.webDriver,e.chromeDriver,e.axeBuilder,e.validator,e.fs,e.marked,e.escape,e.axios,e.cheerio)}(this,function(e,t,r,n,o,i,s,a,c){"use strict";function l(e){return(t,r)=>e.random?Math.random()<e.random?(t.push(r),t):t:(t.push(r),t)}function u(e){return!/(uploads\/\d{4}\/\d{2}\/)/.test(e)&&!/attachment_id/.test(e)&&!/\.(exe|wmv|avi|flv|mov|mkv|mp..?|swf|ra.?|rm|as.|m4[av]|smi.?|doc|docx|ppt|pptx|pps|ppsx|jpg|png|gif|pdf)$/.test(e)}function d(e){return t=>new RegExp(`^https?://([\\w&&[^\\?=\\&\\.]]*\\.?)*?${e}/?.*$`).test(t)||/^\/\w+/.test(t)}function f(e){return!new RegExp("mailto:\\w+").test(e)}function h(e){const{domain:t,ignore:r,whitelist:o}=e,i=new RegExp(r||"^$"),s=new RegExp(o||".*");return e=>n.isURL(e)&&u(e)&&f(e)&&d(t)(e)&&s.test(e)&&(!!o||!i.test(e))}function p(e){return!(e<0)&&Number.isInteger(e)}function g(e,t,{domain:r}){const n={date:(new Date).toString(),title:`aXe Accessibility Engine Results for ${r}`,reports:t},i=JSON.stringify(n,null,2);o.writeFileSync(e,i)}function v(e,t){return Object.entries(e[t]).reduce((e,[t,r])=>e+r.length,0)}function m(e,t,r){return e+="<ul>",Object.entries(t[r]).forEach(([t,n])=>{e+=`<li style="list-style: none; height: 15px;"><div class="col-xs-2">${t}:</div><div class="col-xs-10"> ${n.length} ${r}</div></li>`}),e+="</ul>"}function b(e,t){const r=new Set;return Object.entries(e[t]).forEach(([e,t])=>{t.forEach(({description:e})=>{r.add(`* ${s(e)}\n`)})}),r.size>0?i([...r].reduce((e,t)=>e+t,"")):`No ${t} detected by axe-core`}function w(e,t){let r=i("## Summary of Overall Test Results");return r+='<table class="summary-table"><thead><tr><th scope="col">URL</th><th scope="col">Failing Tests</th><th scope="col">Passing Tests</th></thead><tbody>',Object.entries(e).forEach(([e,t])=>{r+=`<tr><th scope="row">${e}</th>`,r+=`<td>${b(t,"violations")}</td>`,r+=`<td>${b(t,"passes")}</td></tr>`}),r+="</tbody></table>"}function y(e,t,r){function n(e,{html:t,any:r,all:n,none:o}){return e+=`<li>${s(t)}`,r.forEach(({message:t})=>{e+=`<br />${s(t)}`}),n.forEach(({message:t})=>{e+=`<br />${s(t)}`}),o.forEach(({message:t})=>{e+=`<br />${s(t)}`}),e+="</li>"}function a([e,t]){if(t.length>0){const r=`<h4>${e.toUpperCase()}</h4><br/><ol>${t.reduce((e,{description:t,nodes:r,impact:o})=>(e+=`<li>${o?`${o.toUpperCase()}: `:""}${s(t)}<br />`,e+="<span>Affected Nodes: </span><ul>",e+=r.reduce(n,""),e+="</ul></li>"),"")}`;d+=`${r}</ol>`}}const{logger:c}=r,l=`aXe Accessibility Engine Report for ${r.domain}  \n${(new Date).toString()}`;let u='<!doctype html> <html lang="en"><head>';u+=`<title>${l}</title>`,u+='<meta name="viewport" content="width=device-width, initial-scale=1">',u+='<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.8.0/github-markdown.css">',u+='<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">',u+=T;let d='</head><body><div class="container"><div class="row"><div class="col-xs-12">';d+=i(`# ${l}`),d+=i("This report is not a complete accessibility audit.  This report only documents those accessibility features tested by the axe-core library, and should not be considered exhaustive of the possible accessibility issues a website may have.  Use this report as a tool in a complete and comprehensive process of reviewing this site for accessibility issues.  More information regarding the features tested by the axe-core library may be found at [axe-core.org](https://axe-core.org/)"),1!==r.random&&(d+=i(`This report represents only a random sample of ${Math.round(100*r.random)}% of all webpages on this domain.`)),d+=w(t,r),d+='<div class="row"><div class="col-xs-12">';try{d+=`${i(`## Detailed List of Failing Tests: ${Object.entries(t).reduce((e,[t,r])=>e+v(r,"violations"),0)} total failing tests`)}</div></div>`}catch(e){c.error("Error counting failed tests: ",e),d+=i("## Detailed List of Failing Tests")}d+='<div class="row"><div class="col-xs-12">',Object.entries(t).forEach(([e,t])=>{const r=v(t,"violations");d+=i(`### ${s(e)} ${r} violations`),d=m(d,t,"violations"),d+="<br/>",Object.entries(t.violations).forEach(a,"")});try{d+=`${i(`## Summary of Passing Tests: ${Object.entries(t).reduce((e,[t,r])=>e+v(r,"passes"),0)} total passing tests`)}</div></div>`}catch(e){c.error("Error counting passed tests: ",e),d+=i("## Summary of Passing Tests")}Object.entries(t).forEach(([e,t])=>{const r=v(t,"passes");d+=i(`### ${s(e)} ${r} passes`),d=m(d,t,"passes"),d+="<br />",Object.entries(t.passes).forEach(a,"")}),d+="</div></div>";o.writeFileSync(e,u+d+"</body><script><\/script></html>")}function $(e,t){const r=e.replace(new RegExp("^(https?://(\\w+\\.?)+)/(.*)$"),"$1");return n=>{if(t[n].attribs){const o=t[n].attribs.href;if(o)return o.replace(new RegExp(`^(?!https?://)(?!${e}/)(/?)(.*)`),`${r}/$2`).replace(new RegExp(`^${r}//`),"http://")}return null}}function x(e,t,r=(e=>!0)){if(void 0===t)return new Set;if(200===t.status){const e=c.load(t.data)("a"),n=t.config.url;return new Set(Object.keys(e).map($(n,e)).filter(e=>"string"==typeof e).filter(r).map(e=>e.replace(/^https:\/\//,"http://")))}return new Set}function E(e,t){if(e instanceof Set){for(const r of e)t.add(r);return t}return t}function O(e){return e.split(",").map(t=>{const r=/(\w+):(\d+)x(\d+)/;try{const[,n,o,i]=r.exec(t);return{name:n,width:o,height:i}}catch(t){throw new Error("Invalid viewports: ",e)}}).filter(e=>e)}function P(){const e=D(process.argv.slice(2));e.domain=e._.last(),delete e._,e.viewPorts&&(e.viewPorts=O(e.viewPorts),0===e.viewPorts.length&&delete e.viewPorts);let{verbose:t}=e;e.dryRun&&(t=e.verbose||"debug",e.check=0),e.quiet&&(t="quiet");const r=new L(t);e.dryRun&&r.force(`Performing dry run with ${e.verbose} level logging`);const n=e.configFile||_;let o={};try{o=JSON.parse(I.readFileSync(n))}catch(e){"ENOENT"===e.code&&e.path===n?r.error("No config file found"):e instanceof SyntaxError&&(r.error(`Invalid JSON config file ${n}`),r.error("Ignoring JSON config file..."))}return Object.assign(z,o,e,{logger:r,verbose:t})}function S({logger:e}){return(t,{result:r,viewPort:n})=>{try{t[r.url]=Object.assign({violations:{},passes:{}},t[r.url]),t[r.url].violations[n.name]=r.violations,t[r.url].passes[n.name]=r.passes}catch(t){e.error(t)}return t}}function j(e){const{output:t,logger:r}=e;return n=>{r.debug("Creating reports: ",`${t}.json`,`${t}.html`);const o=n.reduce(S(e),{});g(`${t}.json`,o,e),y(`${t}.html`,o,e)}}function k(e){return(t,r)=>(e.viewPorts.forEach(e=>{t.push({url:r,viewPort:e})}),t)}function R({logger:e,verbose:n}){return(()=>{var n=q(function*(n){try{e.debug("Test case: ",n);const{url:o,viewPort:{name:i,width:s,height:a},viewPort:c}=n,l=new F.logging.Preferences;l.setLevel(F.logging.Type.BROWSER,F.logging.Level.OFF),l.setLevel(F.logging.Type.CLIENT,F.logging.Level.OFF);const u=new t.Options;u.setLoggingPrefs(l),u.addArguments("headless","disable-gpu",`--window-size=${s},${a}`);const d=(new F.Builder).forBrowser("chrome").setChromeOptions(u).build();return yield new Promise(function(t,n){e.info(`Getting ${o}`),d.get(o).then(function(){e.info(`Testing ${o} ${i}`),r(d).analyze(function(r,s){s&&n(s),e.debug(`Results for ${o} ${i} received`),t({result:r,viewPort:c}),d.close()})})})}catch(t){e.error("Error encountered in using Selenium Webdriver: "),e.error(t),process.exit(1)}});return function(e){return n.apply(this,arguments)}})()}var F="default"in e?e.default:e;t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,o=o&&o.hasOwnProperty("default")?o.default:o,i=i&&i.hasOwnProperty("default")?i.default:i,s=s&&s.hasOwnProperty("default")?s.default:s,a=a&&a.hasOwnProperty("default")?a.default:a,c=c&&c.hasOwnProperty("default")?c.default:c;const T="<style> h1 { text-align: center; } ol > li { padding-bottom: 15px; font-weight: 500 } ul > li { font-weight: 400; font-size: 12px; } ol > li > span { font-weight: 400; } thead th { text-align: center; } tr { border: 1px solid lightsalmon; } tbody th, tbody td { padding: 5px; text-align: left; vertical-align: text-top; font-weight: normal; } table.summary-table { width: 100%; }</style>";!function(){function e(e){this.value=e}function t(t){function r(o,i){try{var s=t[o](i),a=s.value;a instanceof e?Promise.resolve(a.value).then(function(e){r("next",e)},function(e){r("throw",e)}):n(s.done?"return":"normal",s.value)}catch(e){n("throw",e)}}function n(e,t){switch(e){case"return":o.resolve({value:t,done:!0});break;case"throw":o.reject(t);break;default:o.resolve({value:t,done:!1})}(o=o.next)?r(o.key,o.arg):i=null}var o,i;this._invoke=function(e,t){return new Promise(function(n,s){var a={key:e,arg:t,resolve:n,reject:s,next:null};i?i=i.next=a:(o=i=a,r(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}();var q=function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(o,i){try{var s=t[o](i),a=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(a).then(function(e){n("next",e)},function(e){n("throw",e)});e(a)}return n("next")})}},N=(()=>{var e=q(function*(e,{depth:t=5,logger:r},o){const i=`http://${e}`;if(!n.isURL(i))throw new Error(`Invalid url: ${i}`);if(0===t)return new Set([i]);const s=yield a.get(i).catch(r.error);r.debug("Crawling for links at DEPTH 0");const c=yield x(0,s,o);let l=new Set([...c]);for(let e=1;e<t;e+=1){r.debug(`Crawling for links at DEPTH ${e}`);const n=[...l].map(a.get).map(function(e){return e.catch(function(e){return e})});0===(l=(yield Promise.all(n)).filter(function(e){return!(e instanceof Error)}).map(function(e){return x(0,e,o)}).reduce(E,new Set).difference(c)).size&&(e=t);for(const e of l)c.add(e)}return c});return function(t,r,n){return e.apply(this,arguments)}})();class L{constructor(e){switch(e){case"info":this.verbose="info";break;case"debug":this.verbose="debug";break;case"quiet":this.quiet=!0;break;default:this.verbose="error"}}debug(...e){"debug"!==this.verbose||this.quiet||console.log("DEBUG:",...e)}info(...e){this.quiet||"info"!==this.verbose&&"debug"!==this.verbose||console.log("INFO:",...e)}error(...e){void 0===this.verbose||this.quiet||console.error("ERROR:",...e)}force(...e){console.log(...e)}}const I=require("fs"),D=require("minimist"),_="./.axe-crawler.json",z={depth:5,check:void 0,output:"reports",ignore:".*",whitelist:".*",random:!1,viewPorts:[{name:"mobile",width:360,height:640},{name:"tablet_vertical",width:768,height:1024},{name:"tablet_horizontal",width:1024,height:768},{name:"desktop",width:1440,height:900}],verbose:"error"};let A=(()=>{var e=q(function*(){const e=P(),{logger:t,check:r,viewPorts:n,random:o,domain:i}=e;t.debug("Crawling with options: \n",e);const s=yield N(i,e,h(e));t.info(`Found ${s.size} links within ${i}`),t.debug("Queue to be tested: ",s);const a=Math.min(p(r)?r:1/0,s.size);t.info(`Based on options, testing ${a} urls`),o>0&&o<1?t.info(`Selecting random sample ${o} of total`):e.random=1,t.debug(`Testing ${e.viewPorts.length} views: `),n.forEach(function(e){t.debug(`\t${e.name}: ${e.width}x${e.height}`)}),Promise.all([...s].reduce(l(e),[]).slice(0,a).reduce(k(e),[]).map(R(e))).then(j(e)).catch(e.logger.error)});return function(){return e.apply(this,arguments)}})();!function(){const e=Function.bind.call(Function.call,Array.prototype.reduce),t=Function.bind.call(Function.call,Object.prototype.propertyIsEnumerable),r=Function.bind.call(Function.call,Array.prototype.concat),n=Reflect.ownKeys;Set.prototype.difference=function(e){const t=new Set(this);for(const r of e)t.delete(r);return t},Object.entries||(Object.entries=function(o){return e(n(o),(e,n)=>r(e,"string"==typeof n&&t(o,n)?[[n,o[n]]]:[]),[])}),Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]})}(),A()});
